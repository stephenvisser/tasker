"use strict";angular.module("trelloApp",["ngResource"]).config(["$routeProvider",function(a){a.when("/setup",{templateUrl:"views/board.html",controller:"BoardCtrl"}).when("/choose",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/",{templateUrl:"views/tasks.html",controller:"TaskCtrl"})}]).run(["$location",function(a){localStorage.getItem("board")||a.path("/choose")}]),angular.module("trelloApp").controller("MainCtrl",["$scope","$resource","$location",function(a,b,c){a.boards=b("/api/1/members/me/boards").query(),a.choose=function(a){localStorage.setItem("board",a.id),c.path("/setup")}}]),angular.module("trelloApp").controller("BoardCtrl",["$scope","$resource",function(a,b){a.lists=b("/api/1/boards/:id/lists").query({id:localStorage.getItem("board")})}]),angular.module("trelloApp").controller("TaskCtrl",["$scope","$resource","$http","$q","$timeout",function(a,b,c,d,e){function f(a){return a.data.listAfter.id===localStorage.getItem("inprogress")}function g(){return e(function(){a.elapsedTime&&(a.elapsedTime=a.elapsedTime+1e3)},1e3).then(g)}function h(a){return[a.getMonth()+1,a.getDate(),a.getFullYear()].join("/")}function i(b){if(b){var c=new Date,d=new Date(c.getFullYear(),c.getMonth(),c.getDate()+1);n.query({id:b.id,since:h(c),before:h(d)},function(b){var c=null;a.elapsedTime=b.sort(function(a,b){return new Date(a.date).getTime()-new Date(b.date).getTime()}).reduce(function(a,b){if(f(b))c=b;else if(c)return a+new Date(b.date).getTime()-new Date(c.date).getTime();return a},0),f(c)&&(a.elapsedTime+=(new Date).getTime()-new Date(c.date).getTime())})}}function j(a,b){return c.put("/api/1/cards/"+a.id,{idList:localStorage.getItem(b)})}function k(a,b){var c=-1;return b.some(function(b,d){return b.id===a.id?(c=d,!0):void 0}),b.splice(c,1)[0]}function l(){a.elapsedTime=null,m.query({id:localStorage.getItem("completed")},function(b){a.doneTasks=b});var b=d.defer(),c=d.defer();m.query({id:localStorage.getItem("todo")},function(a){b.resolve(a)}),m.query({id:localStorage.getItem("inprogress")},function(a){c.resolve(a)}),d.all([b.promise,c.promise]).then(function(b){a.inProgressTasks=b[1],i(a.inProgressTasks[0]);var c=Array.prototype.concat.apply([],b),d=[];a.currentTasks.forEach(function(a){var b=k(a,c);b&&d.push(b)}),Array.prototype.push.apply(d,c),a.currentTasks=d})}a.elapsedTime=null,g();var m=b("/api/1/lists/:id/cards"),n=b("/api/1/cards/:id/actions"),o=b("/api/1/lists/:id/actions",{id:localStorage.getItem("inprogress")});a.currentTasks=m.query({id:localStorage.getItem("todo")},function(){a.inProgressTasks=m.query({id:localStorage.getItem("inprogress")},function(b){Array.prototype.unshift.apply(a.currentTasks,b),i(b[0])})}),a.doneTasks=m.query({id:localStorage.getItem("completed")}),a.location={rowNum:1,todoIndex:0,activeIndex:0},a.activities={},a.cards=[],a.empty=function(a){return 0===Object.keys(a).length},a.total=function(a){return Object.keys(a).reduce(function(b,c){return a[c]+b},0)},a.getPosition=function(b){var c=a.total(a.activities);return{left:100*a.cards.slice(0,b).reduce(function(b,c){return b+a.activities[c.id]},0)/c+"%",width:100*a.activities[a.cards[b].id]/c+"%"}},a.relax=function(){a.location.rowNum=2,m.query({id:localStorage.getItem("inprogress")},function(a){d.all(a.map(function(a){return j(a,"todo")})).then(l)});var b=new Date,c=new Date(b.getFullYear(),b.getMonth(),b.getDate()+1);o.query({since:h(b),before:h(c),limit:200},function(b){var c=null;a.cards.length=0,a.activities=b.sort(function(a,b){return new Date(a.date).getTime()-new Date(b.date).getTime()}).reduce(function(b,d){if(c){var e=new Date(d.date).getTime()-new Date(c.date).getTime();b.hasOwnProperty(d.data.card.id)?b[d.data.card.id]+=e:(b[d.data.card.id]=e,a.cards.push(d.data.card)),c=null}else d.data.listAfter.id===localStorage.getItem("inprogress")&&(c=d);return b},{}),c&&f(c)&&(a.activities[c.data.card.id]+=(new Date).getTime()-new Date(c.date).getTime())})};var p;a.viewTask=function(b){a.location.todoIndex=b,a.location.rowNum=0,e.cancel(p),p=e(function(){a.location.rowNum=1},5e3)},a.nextTask=function(){a.startTask(a.location.activeIndex+1)},a.prevTask=function(){a.startTask(a.location.activeIndex-1)},a.nextTodo=function(){a.viewTask(a.location.todoIndex+1)},a.prevTodo=function(){a.viewTask(a.location.todoIndex-1)},a.startTask=function(b){var c=a.currentTasks[b];a.location.activeIndex=b,a.location.rowNum=1,m.query({id:localStorage.getItem("inprogress")},function(a){a.every(function(a){return a.id!==c.id})&&d.all(a.map(function(a){return j(a,"todo")})).then(function(){return j(c,"inprogress").then(l)})})},a.finish=function(b){a.location.rowNum=a.inProgressTasks.some(function(a){return b.id===a.id})?2:1,a.location.activeIndex--,j(b,"completed").then(l)},a.restart=function(b){a.location.activeIndex=a.currentTasks.length,a.location.rowNum=1,m.query({id:localStorage.getItem("inprogress")},function(a){d.all(a.map(function(a){return j(a,"todo")})).then(function(){j(b,"inprogress").then(l)})})},a.isInProgress=function(b){return a.inProgressTasks.some(function(a){return a.id===b.id})}}]),angular.module("trelloApp").controller("ColumnCtrl",["$scope","$element",function(a,b){function c(a){return parseInt(a.style.height,10)}a.locationFromRow=function(a){for(var d=0,e=b[0].firstElementChild,f=0;a>f;)d+=c(e),e=e.nextElementSibling,f++;var g=c(e);return-(d-(100-g)/2)+"%"}}]),angular.module("trelloApp").controller("RowCtrl",["$scope",function(a){a.locationFromColumn=function(a,b){return-(b*a-(100-b)/2)+"%"}}]),angular.module("trelloApp").directive("dragdrop",["$resource",function(a){var b=a("/api/1/lists/:id",null,{get:{method:"GET",cache:!0}});return{scope:!0,link:function(a,c,d){Hammer(c[0]).on("drag",function(a){c.css({top:a.gesture.deltaY+"px",left:a.gesture.deltaX+"px"}),console.log("moving")}).on("dragend",function(b){c.css({position:"static"});var d=angular.element(document.elementFromPoint(b.gesture.center.pageX,b.gesture.center.pageY)).controller("dragdrop");a.$apply(function(){d&&(a.id=d.swapId(a.id))}),console.log("end")}).on("dragstart",function(){a.id&&c.css({position:"relative"}),console.log("start")}),a.$watch("id",function(a){a&&(b.get({id:a},function(a){c.text(a.name)}),d.persistanceProperty&&localStorage.setItem(d.persistanceProperty,a)),c.text(d.defaultText||"")}),a.id=a.$eval(d.dragdrop)},controller:["$scope","$attrs",function(a){this.swapId=function(b){var c=a.id;return a.id=b,c}}]}}]),angular.module("trelloApp").filter("time",function(){var a={Hours:3600,Minutes:60,Seconds:1};return function(b){if(null!=b){var c=b/1e3;return["Hours","Minutes","Seconds"].map(function(b){var d=Math.floor(c/a[b]);return c-=d*a[b],(1===d.toString().length?"0":"")+d}).join(":")}}}),["swipeup","swipedown","swipeleft","swiperight","tap"].forEach(function(a){var b="hmr"+a[0].toUpperCase()+a.slice(1);angular.module("trelloApp").directive(b,function(){return function(c,d,e){Hammer(d[0]).on(a,function(){c.$apply(function(){c.$eval(e[b])})})}})}),angular.module("trelloApp").filter("lookup",function(){return function(a,b){return b[a]}});
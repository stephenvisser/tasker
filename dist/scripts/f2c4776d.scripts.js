"use strict";function dateString(a){return[a.getMonth()+1,a.getDate(),a.getFullYear()].join("/")}angular.module("trelloApp",["ngResource"]).config(["$routeProvider",function(a){a.when("/setup",{templateUrl:"views/board.html",controller:"BoardCtrl"}).when("/choose",{templateUrl:"views/main.html",controller:"MainCtrl"}).when("/",{templateUrl:"views/tasks.html",controller:"TaskCtrl"})}]).run(["$location",function(a){localStorage.getItem("board")?localStorage.getItem("todo")&&localStorage.getItem("inprogress")&&localStorage.getItem("completed")||a.path("/setup"):a.path("/choose")}]),angular.module("trelloApp").service("trello",["$resource","$q",function(a,b){function c(a,c){var d=b.defer();return a.query(c,function(a){d.resolve(a)}),d.promise}var d=new Date,e=dateString(d),f=dateString(new Date(d.getFullYear(),d.getMonth(),d.getDate()+1)),g=a("/api/1/lists/:id/cards"),h=a("/api/1/cards/:id/actions",{since:e,before:f}),i=a("/api/1/lists/:id/actions",{id:localStorage.getItem("inprogress"),since:e,before:f});return{getCardsInList:function(a){return c(g,{id:a})},getActionsForCard:function(a){return c(h,{id:a})},getAllActions:function(){return c(i,{})}}}]),angular.module("trelloApp").controller("MainCtrl",["$scope","$resource","$location",function(a,b,c){a.boards=b("/api/1/members/me/boards").query(),a.choose=function(a){localStorage.setItem("board",a.id),c.path("/setup")}}]),angular.module("trelloApp").controller("BoardCtrl",["$scope","$resource",function(a,b){a.lists=b("/api/1/boards/:id/lists").query({id:localStorage.getItem("board")})}]),angular.module("trelloApp").controller("TaskCtrl",["$scope","$resource","$http","$q","$timeout","trello",function(a,b,c,d,e,f){function g(a){return a.data.listAfter.id===localStorage.getItem("inprogress")}function h(){return e(function(){a.elapsedTime&&(a.elapsedTime=a.elapsedTime+1e3)},1e3).then(h)}function i(a,b){return new Date(a).getTime()-new Date(b).getTime()}function j(b){return b?f.getActionsForCard(b.id).then(function(c){if(0===c.length)return l(b,"todo").then(function(){return l(b,"inprogress")}).then(function(){return j(b)});var d=null;a.elapsedTime=c.sort(function(a,b){return i(a.date,b.date)}).reduce(function(a,b){if(g(b))d=b;else if(d)return a+i(b.date,d.date);return a},0),g(d)&&(a.elapsedTime+=(new Date).getTime()-new Date(d.date).getTime())}):void 0}function k(a){r=r.then(a)}function l(a,b){return c.put("/api/1/cards/"+a.id,{idList:localStorage.getItem(b)})}function m(a,b){var c=-1;return b.some(function(b,d){return b.id===a.id?(c=d,!0):void 0}),b.splice(c,1)[0]}function n(a,b){var c=[];return a.forEach(function(a){var d=m(a,b);d&&c.push(d)}),Array.prototype.push.apply(c,b),c}function o(){return d.all([f.getCardsInList(localStorage.getItem("todo")),f.getCardsInList(localStorage.getItem("inprogress")),f.getCardsInList(localStorage.getItem("completed"))]).then(function(b){return a.currentTasks=n(a.currentTasks,b[1].concat(b[0])),a.inProgressTasks=b[1],a.doneTasks=b[2],j(b[1][0])})}function p(){return f.getAllActions().then(function(b){var c=null;a.cards.length=0,a.activities={},b.sort(function(a,b){return i(a.date,b.date)}).forEach(function(b){if(c){var d=i(b.date,c.date);a.activities.hasOwnProperty(b.data.card.id)?a.activities[b.data.card.id]+=d:(a.activities[b.data.card.id]=d,a.cards.push(b.data.card)),c=null}else b.data.listAfter.id===localStorage.getItem("inprogress")&&(c=b)}),c&&g(c)&&(a.activities[c.data.card.id]+=(new Date).getTime()-new Date(c.date).getTime())})}function q(){return f.getCardsInList(localStorage.getItem("inprogress")).then(function(a){return d.all(a.map(function(a){return l(a,"todo")})).then(o)})}h();var r=d.when();a.elapsedTime=null,a.currentTasks=[],a.inProgressTasks=[],a.doneTasks=[],a.activities={},a.cards=[],k(function(){return o()}),a.location={rowNum:1,todoIndex:0,activeIndex:0},a.empty=function(a){return 0===Object.keys(a).length},a.total=function(a){return Object.keys(a).reduce(function(b,c){return a[c]+b},0)},a.getPosition=function(b){var c=a.total(a.activities);return{left:100*a.cards.slice(0,b).reduce(function(b,c){return b+a.activities[c.id]},0)/c+"%",width:100*a.activities[a.cards[b].id]/c+"%"}},a.relax=function(){a.location.rowNum=2,k(function(){return d.all([p(),q()])})};var s;a.viewTask=function(b){a.location.todoIndex=b,a.location.rowNum=0,e.cancel(s),s=e(function(){a.location.rowNum=1},5e3)},a.nextTask=function(){a.startTask(a.location.activeIndex+1)},a.prevTask=function(){a.startTask(a.location.activeIndex-1)},a.nextTodo=function(){a.viewTask(a.location.todoIndex+1)},a.prevTodo=function(){a.viewTask(a.location.todoIndex-1)},a.startTask=function(b){var c=a.currentTasks[b];a.location.activeIndex=b,a.location.rowNum=1,k(function(){return f.getCardsInList(localStorage.getItem("inprogress")).then(function(a){return!a[0]||a.length>1||a[0].id!==c.id?d.all(a.map(function(a){return l(a,"todo")}).concat(l(c,"inprogress"))).then(o):void 0})})},a.finish=function(b){a.location.rowNum=a.inProgressTasks.some(function(a){return b.id===a.id})?2:1,a.location.activeIndex--,k(function(){return l(b,"completed").then(o)})},a.restart=function(b){a.location.activeIndex=a.currentTasks.length,a.location.rowNum=1,k(function(){f.getCardsInList(localStorage.getItem("inprogress")).then(function(a){return d.all(a.map(function(a){return l(a,"todo")}).concat(l(b,"inprogress"))).then(o)})})},a.isInProgress=function(b){return a.inProgressTasks.some(function(a){return a.id===b.id})}}]),angular.module("trelloApp").controller("ColumnCtrl",["$scope","$element",function(a,b){function c(a){return parseInt(a.style.height,10)}a.locationFromRow=function(a){for(var d=0,e=b[0].firstElementChild,f=0;a>f;)d+=c(e),e=e.nextElementSibling,f++;var g=c(e);return-(d-(100-g)/2)+"%"}}]),angular.module("trelloApp").controller("RowCtrl",["$scope",function(a){a.locationFromColumn=function(a,b){return-(b*a-(100-b)/2)+"%"}}]),angular.module("trelloApp").directive("dragdrop",["$resource",function(a){var b=a("/api/1/lists/:id",null,{get:{method:"GET",cache:!0}});return{scope:!0,link:function(a,c,d){Hammer(c[0]).on("drag",function(a){c.css({top:a.gesture.deltaY+"px",left:a.gesture.deltaX+"px"})}).on("dragend",function(b){c.css({position:"static"});var d=angular.element(document.elementFromPoint(b.gesture.center.pageX,b.gesture.center.pageY)).controller("dragdrop");a.$apply(function(){d&&(a.id=d.swapId(a.id))})}).on("dragstart",function(){a.id&&c.css({position:"relative"})}),a.$watch("id",function(a){a&&(b.get({id:a},function(a){c.text(a.name)}),d.persistanceProperty&&localStorage.setItem(d.persistanceProperty,a)),c.text(d.defaultText||"")}),a.id=a.$eval(d.dragdrop)},controller:["$scope","$attrs",function(a){this.swapId=function(b){var c=a.id;return a.id=b,c}}]}}]),angular.module("trelloApp").filter("time",function(){var a={Hours:3600,Minutes:60,Seconds:1};return function(b){if(null!=b){var c=b/1e3;return["Hours","Minutes","Seconds"].map(function(b){var d=Math.floor(c/a[b]);return c-=d*a[b],(1===d.toString().length?"0":"")+d}).join(":")}}}),["swipeup","swipedown","swipeleft","swiperight","tap"].forEach(function(a){var b="hmr"+a[0].toUpperCase()+a.slice(1);angular.module("trelloApp").directive(b,function(){return function(c,d,e){Hammer(d[0]).on(a,function(){c.$apply(function(){c.$eval(e[b])})})}})}),angular.module("trelloApp").filter("lookup",function(){return function(a,b){return b[a]}});